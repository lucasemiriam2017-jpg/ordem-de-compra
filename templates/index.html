<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordem de Compra</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f4f6f8;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            background: white;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 1000px;
            margin-top: 40px;
            margin-bottom: 60px;
        }

        h3 {
            background-color: #004C99;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 20px;
        }

        label {
            font-weight: 600;
            margin-top: 8px;
        }

        .form-control:focus {
            border-color: #004C99;
            box-shadow: 0 0 0 0.15rem rgba(0, 76, 153, 0.25);
        }

        .btn-primary {
            background-color: #004C99;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background-color: #003870;
        }

        .table th {
            background-color: #004C99;
            color: white;
            text-align: center;
        }

        .table td {
            vertical-align: middle;
        }

        small.text-danger {
            display: none;
        }

        .error-border {
            border-color: #dc3545 !important;
        }

        .info-box {
            background-color: #e9f3ff;
            border-left: 4px solid #004C99;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 25px;
            color: #003870;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4 fw-bold text-primary">Cadastro de Ordem de Compra</h2>

    <div class="info-box">
        <b>Processo da ordem de compra:</b><br>
        Enviar a ordem de compra emitida para análise. Após a análise financeira (poderá ser solicitado um valor de ENTRADA),
        será necessário o requerimento assinado e carimbado pela empresa (cliente). Após o envio por e-mail do documento assinado
        e carimbado, será liberado o limite e seguiremos com as instruções para realização da venda.
    </div>

    <!-- Empresa Solicitante -->
    <h3>Empresa Solicitante</h3>
    <div class="row g-3">
        <div class="col-md-6">
            <label>Empresa</label>
            <input type="text" class="form-control required" id="cliente_empresa">
        </div>
        <div class="col-md-6">
            <label>Nome do Responsável</label>
            <input type="text" class="form-control required" id="cliente_responsavel">
        </div>
        <div class="col-md-6">
            <label>CNPJ</label>
            <input type="text" class="form-control required" id="cliente_cnpj" maxlength="18">
        </div>
        <div class="col-md-6">
            <label>Inscrição Estadual</label>
            <input type="text" class="form-control required" id="cliente_ie">
        </div>
        <div class="col-md-8">
            <label>Endereço</label>
            <input type="text" class="form-control required" id="cliente_end">
        </div>
        <div class="col-md-4">
            <label>Cidade / Estado</label>
            <input type="text" class="form-control required" id="cliente_cidade">
        </div>
        <div class="col-md-4">
            <label>Telefone</label>
            <input type="text" class="form-control required" id="cliente_tel" maxlength="15">
        </div>
        <div class="col-md-8">
            <label>E-mail</label>
            <input type="email" class="form-control required" id="cliente_email">
        </div>
    </div>

    <!-- Filial / Fornecedor -->
    <h3 class="mt-4">Filial / Fornecedor</h3>
    <div class="row g-3">
        <div class="col-md-6">
            <label>Nome da Filial</label>
            <input type="text" class="form-control required" id="filial_nome">
        </div>
        <div class="col-md-6">
            <label>Endereço</label>
            <input type="text" class="form-control required" id="filial_end">
        </div>
        <div class="col-md-6">
            <label>Telefone</label>
            <input type="text" class="form-control required" id="filial_tel_resp" maxlength="15">
        </div>
        <div class="col-md-6">
            <label>E-mail</label>
            <input type="email" class="form-control required" id="filial_email">
        </div>
        <div class="col-md-6">
            <label>Ramal</label>
            <input type="text" class="form-control" id="filial_ramal">
        </div>
        <div class="col-md-6">
            <label>Cidade / Estado</label>
            <input type="text" class="form-control required" id="filial_cidade">
        </div>
    </div>

    <!-- Inclusão de Produtos -->
    <h3 class="mt-4">Inclusão de Produtos</h3>
    <div class="table-responsive">
        <table class="table table-bordered align-middle" id="tabelaProdutos">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qtd</th>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>Preço Unit (R$)</th>
                    <th>Total (R$)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-success" id="addProduto">+ Adicionar Produto</button>
    </div>

    <!-- Condição de Pagamento -->
    <h3 class="mt-4">Condição de Pagamento</h3>
    <div class="row g-3">
        <div class="col-md-6">
            <label>Forma de Pagamento</label>
            <input type="text" class="form-control required" id="pagamento">
        </div>
        <div class="col-md-6">
            <label>Prazo de Entrega</label>
            <input type="text" class="form-control required" id="prazo">
        </div>
    </div>

    <!-- Observações -->
    <h3 class="mt-4">Observações</h3>
    <textarea class="form-control" rows="3" id="obs"></textarea>

    <div class="text-center mt-4">
        <button class="btn btn-primary" id="gerarPdf">Gerar PDF</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {

    // Máscaras simples
    function mascaraCNPJ(v) {
        v = v.replace(/\D/g, "");
        v = v.replace(/^(\d{2})(\d)/, "$1.$2");
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
        v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
        v = v.replace(/(\d{4})(\d)/, "$1-$2");
        return v;
    }

    function mascaraTelefone(v) {
        v = v.replace(/\D/g, "");
        v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
        v = v.replace(/(\d{5})(\d)/, "$1-$2");
        return v;
    }

    function formatarMoeda(valor) {
        valor = valor.replace(/\D/g, "");
        valor = (valor / 100).toFixed(2) + "";
        valor = valor.replace(".", ",");
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        return valor;
    }

    // Aplicar máscaras
    $(document).on("input", "#cliente_cnpj", function() {
        this.value = mascaraCNPJ(this.value);
    });

    $(document).on("input", "#cliente_tel, #filial_tel_resp", function() {
        this.value = mascaraTelefone(this.value);
    });

    // Adicionar produto
    $("#addProduto").click(function () {
        let index = $("#tabelaProdutos tbody tr").length + 1;
        $("#tabelaProdutos tbody").append(`
            <tr>
                <td>${index}</td>
                <td><input type="number" class="form-control qtd" min="1"></td>
                <td><input type="text" class="form-control cod"></td>
                <td><input type="text" class="form-control desc"></td>
                <td><input type="text" class="form-control preco"></td>
                <td><input type="text" class="form-control tot" readonly></td>
            </tr>
        `);
    });

    // Formatar e calcular valores
    $(document).on("input", ".preco, .qtd", function () {
        let row = $(this).closest("tr");
        let qtd = parseFloat(row.find(".qtd").val()) || 0;
        let preco = row.find(".preco").val().replace(/\D/g, "");

        if (preco) {
            preco = (parseFloat(preco) / 100).toFixed(2);
            row.find(".preco").val(formatarMoeda(row.find(".preco").val()));
        }

        let precoNum = parseFloat(row.find(".preco").val().replace(/\./g, "").replace(",", ".")) || 0;
        let total = qtd * precoNum;
        row.find(".tot").val(total ? total.toFixed(2).replace(".", ",").replace(/\B(?=(\d{3})+(?!\d))/g, ".") : "");
    });

    // Geração de PDF
    $("#gerarPdf").click(function () {
        let dados = {
            cliente: {
                "Empresa": $("#cliente_empresa").val(),
                "Responsável": $("#cliente_responsavel").val(),
                "CNPJ": $("#cliente_cnpj").val(),
                "Inscrição Estadual": $("#cliente_ie").val(),
                "Endereço": $("#cliente_end").val(),
                "Cidade/Estado": $("#cliente_cidade").val(),
                "Telefone": $("#cliente_tel").val(),
                "E-mail": $("#cliente_email").val()
            },
            filial: {
                "Nome da Filial": $("#filial_nome").val(),
                "Endereço": $("#filial_end").val(),
                "Telefone": $("#filial_tel_resp").val(),
                "E-mail": $("#filial_email").val(),
                "Ramal": $("#filial_ramal").val(),
                "Cidade/Estado": $("#filial_cidade").val()
            },
            itens: [],
            obs: $("#obs").val(),
            pagamento: $("#pagamento").val(),
            prazo: $("#prazo").val()
        };

        $("#tabelaProdutos tbody tr").each(function () {
            let item = {
                qtd: $(this).find(".qtd").val(),
                cod: $(this).find(".cod").val(),
                desc: $(this).find(".desc").val(),
                preco: $(this).find(".preco").val(),
                tot: $(this).find(".tot").val()
            };
            if (item.qtd || item.cod || item.desc || item.preco) dados.itens.push(item);
        });

        fetch("/gerar_pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados)
        })
        .then(response => response.blob())
        .then(blob => {
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = "Ordem_Compra.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
        });
    });
});
</script>
</body>
</html>
