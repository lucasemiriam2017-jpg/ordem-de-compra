<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input:invalid { border-color: #dc3545; }
.error-msg { color: #dc3545; font-size: 12px; margin-top: 2px; display: none; }
.info-box {
  background: #e9f5ff;
  border-left: 4px solid #007bff;
  padding: 10px 15px;
  border-radius: 8px;
  margin-top: 20px;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra ‚Äî Emiss√£o (PDF)</h3>

  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6">
      <input class="form-control mb-1" id="Empresa" placeholder="Empresa" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required>
      <div class="error-msg">Informe um CNPJ v√°lido</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Inscri√ß√£o Estadual" placeholder="Inscri√ß√£o Estadual" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Endere√ßo" placeholder="Endere√ßo" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Telefone" placeholder="Telefone" required>
      <div class="error-msg">Informe um telefone v√°lido</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="E-mail" placeholder="E-mail" type="email" required>
      <div class="error-msg">Informe um e-mail v√°lido</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Nome do Respons√°vel" placeholder="Nome do Respons√°vel" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Data" placeholder="Data" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
  </div>

  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6">
      <input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Endere√ßo Filial" placeholder="Endere√ßo Filial" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required>
      <div class="error-msg">Informe um telefone v√°lido</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" type="email" required>
      <div class="error-msg">Informe um e-mail v√°lido</div>
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Ramal" placeholder="Ramal">
    </div>
    <div class="col-md-6">
      <input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required>
      <div class="error-msg">Campo obrigat√≥rio</div>
    </div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="error-msg">Campo obrigat√≥rio</div>
  </div>

  <h5>Condi√ß√£o de Pagamento</h5>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="1x" checked>
    <label class="form-check-label">Boleto em 1x</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="2x">
    <label class="form-check-label">Boleto em 2x</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="3x">
    <label class="form-check-label">Boleto em 3x</label>
  </div>

  <h5 class="mt-4">Inclus√£o de Produtos</h5>
  <div id="area-itens">
    <div class="row mb-3">
      <div class="col"><input class="form-control" id="qtd" placeholder="Qtd"></div>
      <div class="col"><input class="form-control" id="cod" placeholder="C√≥digo"></div>
      <div class="col"><input class="form-control" id="desc" placeholder="Descri√ß√£o"></div>
      <div class="col"><input class="form-control" id="preco" placeholder="Pre√ßo Unit√°rio"></div>
      <div class="col"><button class="btn btn-success" onclick="addItem()">Adicionar</button></div>
    </div>

    <table class="table table-sm" id="tabela_itens">
      <thead><tr><th>Qtd</th><th>C√≥digo</th><th>Descri√ß√£o</th><th>Pre√ßo Unit (R$)</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="mt-3">
    <label>Observa√ß√µes</label>
    <input class="form-control" id="obs" placeholder="Observa√ß√µes">
  </div>

  <!-- üí° Mensagem explicativa -->
  <div class="info-box">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para an√°lise, ap√≥s a realiza√ß√£o da an√°lise financeira (ter√° a possibilidade de solicita√ß√£o de um valor de ENTRADA), solicitaremos o requerimento assinado e carimbado pela empresa (cliente). Ap√≥s envio por e-mail do documento assinado e carimbado pela empresa, ser√° liberado o limite e seguiremos com as instru√ß√µes para realiza√ß√£o da venda.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<script>
document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
let itens = [];

$("#CNPJ").mask("00.000.000/0000-00");
$("#Telefone, #Telefone\\ Filial").mask("(00) 00000-0000");

function addItem() {
  const q = $("#qtd").val();
  const c = $("#cod").val();
  const d = $("#desc").val();
  const p = $("#preco").val().replace(",", ".");
  if (!q || !c || !d || !p) return alert("Preencha todos os campos do item!");
  const tot = (parseFloat(q) * parseFloat(p)).toFixed(2);
  itens.push({ qtd: q, cod: c, desc: d, preco: parseFloat(p).toFixed(2).replace(".", ","), tot });
  atualizarTabela();
  $("#qtd, #cod, #desc, #preco").val("");
}

function atualizarTabela() {
  const tbody = $("#tabela_itens tbody");
  tbody.empty();
  itens.forEach((it, i) => {
    tbody.append(`<tr>
      <td>${it.qtd}</td><td>${it.cod}</td><td>${it.desc}</td><td>${it.preco}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removerItem(${i})">X</button></td></tr>`);
  });
}

function removerItem(i) {
  itens.splice(i, 1);
  atualizarTabela();
}

function limpar() {
  $("input").val("");
  $("#Data").val(new Date().toLocaleDateString("pt-BR"));
  itens = [];
  atualizarTabela();
  $(".error-msg").hide();
  $("input").css("border-color", "");
}

async function gerarPDF() {
  let valido = true;
  $("input[required]").each(function() {
    const val = $(this).val().trim();
    const id = $(this).attr("id");
    const err = $(this).next(".error-msg");
    if (!val) {
      $(this).css("border-color", "#dc3545");
      err.show();
      valido = false;
    } else if (id.includes("E-mail") && !val.includes("@")) {
      $(this).css("border-color", "#dc3545");
      err.text("Informe um e-mail v√°lido").show();
      valido = false;
    } else {
      $(this).css("border-color", "");
      err.hide();
    }
  });

  if (!valido) return;

  if (itens.length === 0) return alert("Adicione ao menos um item.");

  const cliente = {};
  ["Empresa","CNPJ","Inscri√ß√£o Estadual","Endere√ßo","Cidade/Estado","Telefone","E-mail","Nome do Respons√°vel","Data"]
    .forEach(id => cliente[id] = $("#" + id).val());

  const filial = {};
  ["Nome Filial","Endere√ßo Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"]
    .forEach(id => filial[id] = $("#" + id).val());

  const pagamento = $("input[name='pagamento']:checked").val();
  const payload = {
    cliente, filial, itens,
    obs: $("#obs").val(),
    pagamento, prazo: $("#prazo").val()
  };

  const resp = await fetch("/gerar_pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const blob = await resp.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ordem_Compra.pdf";
  a.click();
}
</script>
</body>
</html>
