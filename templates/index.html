<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Ordem de Compra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

  <div class="container bg-white p-4 rounded shadow">
    <h2 class="mb-4 text-center">Ordem de Compra</h2>

    <!-- EMPRESA SOLICITANTE -->
    <h5>Empresa Solicitante</h5>
    <div class="row">
      <div class="col-md-6"><input class="form-control mb-2" id="Empresa" placeholder="Empresa" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="CNPJ" placeholder="CNPJ" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Inscrição Estadual" placeholder="Inscrição Estadual" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Endereço" placeholder="Endereço" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Cidade/Estado" placeholder="Cidade/Estado" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Telefone" placeholder="Telefone" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="E-mail" type="email" placeholder="E-mail" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Data" placeholder="Data" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Nome do Responsável" placeholder="Nome do Responsável" required></div>
    </div>

    <hr>

    <!-- FILIAL / FORNECEDOR -->
    <h5>Filial / Fornecedor</h5>
    <div class="row">
      <div class="col-md-6"><input class="form-control mb-2" id="Nome Filial" placeholder="Nome Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Endereço Filial" placeholder="Endereço Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Telefone Filial" placeholder="Telefone Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="E-mail Filial" type="email" placeholder="E-mail Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Ramal" placeholder="Ramal" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required></div>
    </div>

    <hr>

    <!-- ITENS -->
    <h5>Itens da Ordem de Compra</h5>
    <div class="row mb-2">
      <div class="col-md-4"><input class="form-control" id="descricao" placeholder="Descrição do Item"></div>
      <div class="col-md-2"><input class="form-control" id="quantidade" placeholder="Qtd" type="number" min="1"></div>
      <div class="col-md-3"><input class="form-control" id="valor" placeholder="Valor Unitário" type="number" step="0.01"></div>
      <div class="col-md-3"><button class="btn btn-primary w-100" onclick="adicionarItem()">Adicionar</button></div>
    </div>

    <table class="table table-bordered" id="tabelaItens">
      <thead class="table-light">
        <tr><th>Descrição</th><th>Qtd</th><th>Valor Unitário</th><th>Total</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr>

    <!-- PAGAMENTO -->
    <div class="mb-3">
      <label class="form-label">Forma de Pagamento:</label><br>
      <input type="radio" name="pagamento" value="Pix" checked> Pix
      <input type="radio" name="pagamento" value="Boleto"> Boleto
      <input type="radio" name="pagamento" value="Cartão"> Cartão
    </div>

    <div class="mb-3">
      <input class="form-control" id="prazo" placeholder="Prazo de Entrega" required>
    </div>

    <div class="mb-3">
      <textarea class="form-control" id="obs" placeholder="Observações (opcional)" rows="3"></textarea>
    </div>

    <button class="btn btn-success w-100" onclick="gerarPDF()">Gerar PDF</button>
  </div>

  <script>
  let itens = [];

  function adicionarItem() {
    const desc = document.getElementById("descricao").value.trim();
    const qtd = document.getElementById("quantidade").value;
    const val = document.getElementById("valor").value;

    if (!desc || !qtd || !val) {
      alert("Preencha todos os campos do item.");
      return;
    }

    const total = (parseFloat(qtd) * parseFloat(val)).toFixed(2);
    itens.push({ desc, qtd, val, total });
    atualizarTabela();
    document.getElementById("descricao").value = "";
    document.getElementById("quantidade").value = "";
    document.getElementById("valor").value = "";
  }

  function atualizarTabela() {
    const tbody = document.querySelector("#tabelaItens tbody");
    tbody.innerHTML = "";
    itens.forEach((item, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${item.desc}</td>
          <td>${item.qtd}</td>
          <td>R$ ${parseFloat(item.val).toFixed(2)}</td>
          <td>R$ ${item.total}</td>
          <td><button class="btn btn-danger btn-sm" onclick="removerItem(${i})">Remover</button></td>
        </tr>`;
    });
  }

  function removerItem(i) {
    itens.splice(i, 1);
    atualizarTabela();
  }

  // --- Máscaras automáticas ---
  document.addEventListener("DOMContentLoaded", function() {
    const cnpj = document.getElementById("CNPJ");
    const telefone = document.getElementById("Telefone");
    const telefoneFilial = document.getElementById("Telefone Filial");
    const data = document.getElementById("Data");

    function aplicarMascaraCNPJ(valor) {
      return valor.replace(/\D/g, "")
        .replace(/^(\d{2})(\d)/, "$1.$2")
        .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
        .replace(/\.(\d{3})(\d)/, ".$1/$2")
        .replace(/(\d{4})(\d)/, "$1-$2")
        .slice(0, 18);
    }

    function aplicarMascaraTelefone(valor) {
      return valor.replace(/\D/g, "")
        .replace(/^(\d{2})(\d)/g, "($1) $2")
        .replace(/(\d{5})(\d{4})$/, "$1-$2")
        .slice(0, 15);
    }

    function aplicarMascaraData(valor) {
      return valor.replace(/\D/g, "")
        .replace(/^(\d{2})(\d)/, "$1/$2")
        .replace(/(\d{2})\/(\d{2})(\d)/, "$1/$2/$3")
        .slice(0, 10);
    }

    cnpj.addEventListener("input", e => e.target.value = aplicarMascaraCNPJ(e.target.value));
    telefone.addEventListener("input", e => e.target.value = aplicarMascaraTelefone(e.target.value));
    telefoneFilial.addEventListener("input", e => e.target.value = aplicarMascaraTelefone(e.target.value));
    data.addEventListener("input", e => e.target.value = aplicarMascaraData(e.target.value));
  });

  // --- Geração do PDF ---
  async function gerarPDF() {
    const obrigatoriosCliente = [
      "Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado",
      "Telefone","E-mail","Data","Nome do Responsável"
    ];

    const obrigatoriosFilial = [
      "Nome Filial","Endereço Filial","Telefone Filial",
      "E-mail Filial","Ramal","Cidade/Estado Filial"
    ];

    for (let id of [...obrigatoriosCliente, ...obrigatoriosFilial]) {
      const el = document.getElementById(id);
      if (!el.value.trim()) {
        alert(`Preencha o campo obrigatório: ${id}`);
        el.focus();
        return;
      }
    }

    if (itens.length === 0) {
      alert("Adicione ao menos um item antes de gerar o PDF.");
      return;
    }

    const cliente = {};
    obrigatoriosCliente.forEach(id => cliente[id] = document.getElementById(id).value);
    const filial = {};
    obrigatoriosFilial.forEach(id => filial[id] = document.getElementById(id).value);

    const pagamento = document.querySelector("input[name='pagamento']:checked").value;
    const payload = {
      cliente, filial, itens,
      obs: document.getElementById("obs").value,
      pagamento, prazo: document.getElementById("prazo").value
    };

    const resp = await fetch("/gerar_pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Ordem_Compra.pdf";
    a.click();
  }
  </script>
</body>
</html>
