<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input.is-invalid { border-color: #dc3545 !important; }
.invalid-feedback { display: none; color: #dc3545; font-size: 0.9em; margin-top: 2px; }
input.is-invalid + .invalid-feedback { display: block; }
.info-box { background: #f1f5ff; border-left: 4px solid #0d6efd; padding: 10px 15px; border-radius: 6px; font-size: 0.95em; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra — Emissão (PDF)</h3>

  <!-- Empresa solicitante -->
  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Empresa" placeholder="Empresa" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Inscrição Estadual" placeholder="Inscrição Estadual" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço" placeholder="Endereço" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone" placeholder="Telefone" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail" placeholder="E-mail (para recebimento de boleto)" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Nome do Responsável" placeholder="Nome do Responsável" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Data" placeholder="Data" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <!-- Filial / Fornecedor -->
  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço Filial" placeholder="Endereço Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Ramal" placeholder="Ramal" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="invalid-feedback">⚠️ Preencha este campo.</div>
  </div>

  <hr>

  <!-- Inclusão de Produtos -->
  <h5>Inclusão de Produtos</h5>
  <div id="area-itens" class="mb-4">
    <table class="table table-bordered align-middle" id="tabela_itens">
      <thead style="background-color: white; color: #004aad; text-align:center;">
        <tr>
          <th style="width:5%">Item</th>
          <th style="width:10%">Qtd</th>
          <th style="width:15%">Código</th>
          <th>Descrição</th>
          <th style="width:15%">Preço Unit. (R$)</th>
          <th style="width:15%">Total (R$)</th>
          <th style="width:8%">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success mt-2" id="btnAdicionarProduto">Adicionar Produto</button>
  </div>

  <!-- Pagamento -->
  <h5>Condição de Pagamento</h5>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="1x" checked><label class="form-check-label">Boleto em 1x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="2x"><label class="form-check-label">Boleto em 2x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="3x"><label class="form-check-label">Boleto em 3x</label></div>

  <!-- Observações -->
  <div class="mt-3">
    <label>Observações</label>
    <input class="form-control" id="obs" placeholder="Observações (opcional)">
  </div>

  <div class="info-box mt-4">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para análise. Após a análise financeira (poderá ser solicitado um valor de ENTRADA), será necessário o requerimento assinado e carimbado pela empresa (cliente). Após o envio por e-mail do documento assinado e carimbado, será liberado o limite e seguiremos com as instruções para realização da venda.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" id="btnGerarPdf">Gerar PDF</button>
    <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ---- Máscaras e data automática ----
  const cnpj = document.getElementById("CNPJ");
  const telefone = document.getElementById("Telefone");
  const telefoneFilial = document.getElementById("Telefone Filial");
  const data = document.getElementById("Data");

  function maskCNPJ(v){
    return v.replace(/\D/g,"").replace(/^(\d{2})(\d)/,"$1.$2")
            .replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")
            .replace(/\.(\d{3})(\d)/,".$1/$2")
            .replace(/(\d{4})(\d)/,"$1-$2").slice(0,18);
  }
  function maskTel(v){
    return v.replace(/\D/g,"").replace(/^(\d{2})(\d)/,"($1) $2")
            .replace(/(\d{5})(\d{4})$/,"$1-$2").slice(0,15);
  }

  if(cnpj) cnpj.addEventListener("input", e=>e.target.value=maskCNPJ(e.target.value));
  if(telefone) telefone.addEventListener("input", e=>e.target.value=maskTel(e.target.value));
  if(telefoneFilial) telefoneFilial.addEventListener("input", e=>e.target.value=maskTel(e.target.value));
  if(data) data.value = new Date().toLocaleDateString("pt-BR");

  // ---- Tabela de produtos ----
  const tabelaBody = document.querySelector("#tabela_itens tbody");
  let contador = 1;
  let itens = [];

  function criarInput(classe, tipo, placeholder){
    const input = document.createElement("input");
    input.type = tipo || "text";
    input.className = "form-control " + (classe || "");
    if(placeholder) input.placeholder = placeholder;
    return input;
  }

  function formatarValorDinamico(input){
    let v = input.value.replace(/\D/g,"");
    if(!v) { input.value = "0,00"; return; }
    while(v.length < 3) v = "0" + v;
    let centavos = v.slice(-2);
    let reais = v.slice(0,-2);
    reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g,".");
    input.value = reais + "," + centavos;
  }

  window.adicionarLinha = function(){
    const tr = document.createElement("tr");

    const tdItem = document.createElement("td"); tdItem.className="text-center"; tdItem.textContent=contador;
    const tdQtd = document.createElement("td"); const inpQtd = criarInput("qtd","number",""); inpQtd.min=0; tdQtd.appendChild(inpQtd);
    const tdCod = document.createElement("td"); tdCod.appendChild(criarInput("cod","text",""));
    const tdDesc = document.createElement("td"); tdDesc.appendChild(criarInput("desc","text",""));
    const tdPreco = document.createElement("td"); const inpPreco = criarInput("preco","text","0,00"); tdPreco.appendChild(inpPreco);
    const tdTotal = document.createElement("td"); tdTotal.className="text-end total"; tdTotal.textContent="0,00";
    const tdAcoes = document.createElement("td"); tdAcoes.className="text-center";
    const btnRem = document.createElement("button"); btnRem.type="button"; btnRem.className="btn btn-sm btn-danger btn-remover"; btnRem.textContent="X";
    tdAcoes.appendChild(btnRem);

    tr.append(tdItem, tdQtd, tdCod, tdDesc, tdPreco, tdTotal, tdAcoes);
    tabelaBody.appendChild(tr);
    contador++;

    [inpQtd, inpPreco].forEach(inp=>{
      inp.addEventListener("input", calcularTotais);
      inp.addEventListener("wheel", e=>e.preventDefault());
    });
    inpPreco.addEventListener("input", ()=>{ formatarValorDinamico(inpPreco); calcularTotais(); });

    btnRem.addEventListener("click", ()=>{ tr.remove(); calcularTotais(); });
  };

  function calcularTotais(){
    itens = [];
    tabelaBody.querySelectorAll("tr").forEach(tr=>{
      const qtd = parseFloat(tr.querySelector(".qtd")?.value.replace(",",".")||0);
      const preco = parseFloat(tr.querySelector(".preco")?.value.replace(/\./g,"").replace(",",".")||0);
      const total = qtd*preco;
      tr.querySelector(".total").textContent = total.toLocaleString("pt-BR",{minimumFractionDigits:2});
      itens.push({
        qtd:qtd.toString(),
        cod:tr.querySelector(".cod")?.value||"",
        desc:tr.querySelector(".desc")?.value||"",
        preco:preco.toLocaleString("pt-BR",{minimumFractionDigits:2}),
        tot:total.toLocaleString("pt-BR",{minimumFractionDigits:2})
      });
    });
  }

  document.getElementById("btnAdicionarProduto").addEventListener("click", window.adicionarLinha);

  // ---- Validação campos ----
  const requiredInputs = document.querySelectorAll("input[required]");
  requiredInputs.forEach(input=>{
    input.addEventListener("blur", ()=>{ if(!input.value.trim()) input.classList.add("is-invalid"); });
    input.addEventListener("input", ()=>{ if(input.value.trim()) input.classList.remove("is-invalid"); });
  });

  // ---- Gerar PDF ----
  window.gerarPDF = async function(){
    const obrigatorios = ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data",
      "Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial","prazo"];
    let primeiroErro=null;
    obrigatorios.forEach(id=>{
      const el=document.getElementById(id);
      if(el && !el.value.trim()){ el.classList.add("is-invalid"); if(!primeiroErro) primeiroErro=el; }
    });
    if(primeiroErro){ primeiroErro.scrollIntoView({behavior:"smooth", block:"center"}); primeiroErro.focus(); return; }

    calcularTotais();
    if(itens.length===0){ alert("⚠️ Adicione ao menos um item antes de gerar o PDF."); return; }

    const cliente={}, filial={};
    ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data"].forEach(id=>cliente[id]=document.getElementById(id)?.value||"");
    ["Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"].forEach(id=>filial[id]=document.getElementById(id)?.value||"");
    const pagamento = document.querySelector("input[name='pagamento']:checked")?.value||"";
    const payload = { cliente, filial, itens, obs:document.getElementById("obs")?.value||"", pagamento, prazo:document.getElementById("prazo")?.value||"" };

    try{
      const resp = await fetch("/gerar_pdf", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
      if(!resp.ok){ const text=await resp.text(); throw new Error("Erro servidor: "+(text||resp.statusText)); }
      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="Ordem_Compra.pdf"; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
    } catch(err){ console.error(err); alert("Erro ao gerar PDF. Veja console."); }
  };

  // ---- Limpar formulário ----
  document.getElementById("btnLimpar").addEventListener("click", ()=>{
    document.querySelectorAll("input").forEach(i=>{ i.value=""; i.classList.remove("is-invalid"); });
    if(data) data.value = new Date().toLocaleDateString("pt-BR");
    tabelaBody.innerHTML=""; itens=[]; contador=1;
  });

});
</script>
</body>
</html>
