<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Ordem de Compra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f7fa;
      font-family: "Segoe UI", sans-serif;
    }
    .container {
      background: white;
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-top: 30px;
      margin-bottom: 30px;
    }
    h4, h5 {
      margin-top: 20px;
      color: #333;
      font-weight: 600;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #0d6efd !important;
      box-shadow: 0 0 6px rgba(13,110,253,0.3) !important;
    }
    input.is-invalid {
      border-color: #dc3545 !important;
      box-shadow: 0 0 6px rgba(220,53,69,0.4) !important;
    }
    .alert-campos {
      display: none;
      margin-top: 10px;
      background: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 10px 15px;
      font-weight: 500;
    }
    .btn-primary {
      border-radius: 10px;
      padding: 10px 25px;
    }
    table {
      margin-top: 15px;
    }
  </style>
</head>
<body>
<div class="container">
  <h4 class="mb-3">Cadastro de Ordem de Compra</h4>

  <form id="ordemForm" onsubmit="gerarPDF(); return false;">

    <!-- Empresa Solicitante -->
    <h5>Empresa Solicitante</h5>
    <div class="row">
      <div class="col-md-6"><input class="form-control mb-2" id="Empresa" placeholder="Empresa" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="CNPJ" placeholder="CNPJ" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Inscrição Estadual" placeholder="Inscrição Estadual" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Endereço" placeholder="Endereço" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Cidade/Estado" placeholder="Cidade/Estado" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Telefone" placeholder="Telefone" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="E-mail" type="email" placeholder="E-mail" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Data" placeholder="Data" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Nome do Responsável" placeholder="Nome do Responsável" required></div>
    </div>

    <!-- Filial / Fornecedor -->
    <h5>Filial / Fornecedor</h5>
    <div class="row">
      <div class="col-md-6"><input class="form-control mb-2" id="Nome Filial" placeholder="Nome Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Endereço Filial" placeholder="Endereço Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Telefone Filial" placeholder="Telefone Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="E-mail Filial" type="email" placeholder="E-mail Filial" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Ramal" placeholder="Ramal" required></div>
      <div class="col-md-6"><input class="form-control mb-2" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required></div>
    </div>

    <!-- Itens -->
    <h5>Itens</h5>
    <div class="row g-2">
      <div class="col-md-4"><input class="form-control" id="descricao" placeholder="Descrição" required></div>
      <div class="col-md-2"><input type="number" min="1" class="form-control" id="quantidade" placeholder="Qtd" required></div>
      <div class="col-md-2"><input type="text" class="form-control valor-item" id="valor" placeholder="Valor (R$)" required></div>
      <div class="col-md-2 d-grid"><button type="button" class="btn btn-success" onclick="adicionarItem()">Adicionar</button></div>
    </div>

    <table class="table table-striped" id="tabelaItens">
      <thead><tr><th>Descrição</th><th>Qtd</th><th>Valor (R$)</th><th>Total (R$)</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="alert-campos" id="alertCampos"></div>

    <div class="mt-3">
      <label>Observações</label>
      <textarea class="form-control" id="obs" rows="3" placeholder="Opcional"></textarea>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="btn btn-primary">Gerar PDF</button>
    </div>

  </form>
</div>

<script>
// ------------------ Máscaras ------------------

// CNPJ
function aplicarMascaraCNPJ(valor) {
  return valor
    .replace(/\D/g, "")
    .replace(/^(\d{2})(\d)/, "$1.$2")
    .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/\.(\d{3})(\d)/, ".$1/$2")
    .replace(/(\d{4})(\d)/, "$1-$2")
    .slice(0, 18);
}

// Telefone
function aplicarMascaraTelefone(valor) {
  return valor
    .replace(/\D/g, "")
    .replace(/^(\d{2})(\d)/, "($1) $2")
    .replace(/(\d{5})(\d{4})$/, "$1-$2")
    .slice(0, 15);
}

// Aplicar automaticamente
document.addEventListener("input", function(e) {
  if (e.target.id === "CNPJ") e.target.value = aplicarMascaraCNPJ(e.target.value);
  if (e.target.id === "Telefone" || e.target.id === "Telefone Filial") e.target.value = aplicarMascaraTelefone(e.target.value);
});

// ------------------ Máscara Valor (R$) ------------------
document.addEventListener("input", function (e) {
  if (e.target && e.target.classList.contains("valor-item")) {
    let valor = e.target.value.replace(/\D/g, "");
    if (valor === "") return e.target.value = "";
    valor = (parseInt(valor, 10) / 100).toFixed(2) + "";
    valor = valor.replace(".", ",");
    valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    e.target.value = valor;
  }
});

// ------------------ Validação de Campos ------------------
document.querySelectorAll("input[required]").forEach(input => {
  input.addEventListener("blur", () => {
    if (!input.value.trim()) input.classList.add("is-invalid");
    else input.classList.remove("is-invalid");
  });
});

function validarEmail(email) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

const itens = [];

function adicionarItem() {
  const desc = document.getElementById("descricao");
  const qtd = document.getElementById("quantidade");
  const val = document.getElementById("valor");

  if (!desc.value || !qtd.value || !val.value) return;

  const valorNum = parseFloat(val.value.replace(/\./g, "").replace(",", "."));
  const total = valorNum * parseInt(qtd.value);
  itens.push({ descricao: desc.value, quantidade: qtd.value, valor: val.value, total: total.toFixed(2).replace(".", ",") });

  const tbody = document.querySelector("#tabelaItens tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${desc.value}</td><td>${qtd.value}</td><td>${val.value}</td><td>${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
  <td><button type='button' class='btn btn-sm btn-danger' onclick='removerItem(this)'>X</button></td>`;
  tbody.appendChild(tr);

  desc.value = qtd.value = val.value = "";
}

function removerItem(btn) {
  const row = btn.closest("tr");
  const index = Array.from(row.parentNode.children).indexOf(row);
  itens.splice(index, 1);
  row.remove();
}

// ------------------ Geração PDF ------------------
async function gerarPDF() {
  const obrigatorios = Array.from(document.querySelectorAll("input[required]"));
  const alertBox = document.getElementById("alertCampos");
  alertBox.style.display = "none";

  for (let input of obrigatorios) {
    if (!input.value.trim()) {
      input.classList.add("is-invalid");
      alertBox.textContent = `⚠️ O campo "${input.placeholder}" é obrigatório.`;
      alertBox.style.display = "block";
      input.focus();
      return;
    } else {
      input.classList.remove("is-invalid");
    }

    if (input.type === "email" && !validarEmail(input.value)) {
      input.classList.add("is-invalid");
      alertBox.textContent = `⚠️ O e-mail "${input.value}" não é válido.`;
      alertBox.style.display = "block";
      input.focus();
      return;
    }
  }

  if (itens.length === 0) {
    alertBox.textContent = "⚠️ Adicione pelo menos um item antes de gerar o PDF.";
    alertBox.style.display = "block";
    return;
  }

  const cliente = {
    Empresa: Empresa.value,
    CNPJ: CNPJ.value,
    "Inscrição Estadual": document.getElementById("Inscrição Estadual").value,
    Endereço: Endereço.value,
    "Cidade/Estado": document.getElementById("Cidade/Estado").value,
    Telefone: Telefone.value,
    "E-mail": document.getElementById("E-mail").value,
    Data: Data.value,
    "Nome do Responsável": document.getElementById("Nome do Responsável").value
  };

  const filial = {
    "Nome Filial": document.getElementById("Nome Filial").value,
    "Endereço Filial": document.getElementById("Endereço Filial").value,
    "Telefone Filial": document.getElementById("Telefone Filial").value,
    "E-mail Filial": document.getElementById("E-mail Filial").value,
    Ramal: document.getElementById("Ramal").value,
    "Cidade/Estado Filial": document.getElementById("Cidade/Estado Filial").value
  };

  const payload = {
    cliente,
    filial,
    itens,
    obs: document.getElementById("obs").value
  };

  const resp = await fetch("/gerar_pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const blob = await resp.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ordem_Compra.pdf";
  a.click();
}
</script>
</body>
</html>
