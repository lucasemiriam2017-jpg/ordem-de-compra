<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input.is-invalid { border-color: #dc3545 !important; }
.invalid-feedback { display: none; color: #dc3545; font-size: 0.9em; margin-top: 2px; }
input.is-invalid + .invalid-feedback { display: block; }
.info-box { background: #f1f5ff; border-left: 4px solid #0d6efd; padding: 10px 15px; border-radius: 6px; font-size: 0.95em; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra — Emissão (PDF)</h3>

  <!-- Empresa solicitante -->
  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Empresa" placeholder="Empresa" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Inscrição Estadual" placeholder="Inscrição Estadual" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço" placeholder="Endereço" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone" placeholder="Telefone" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail" placeholder="E-mail (para recebimento de boleto)" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Nome do Responsável" placeholder="Nome do Responsável" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Data" placeholder="Data" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <!-- Filial / Fornecedor -->
  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço Filial" placeholder="Endereço Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Ramal" placeholder="Ramal" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="invalid-feedback">⚠️ Preencha este campo.</div>
  </div>

  <hr>

  <!-- Inclusão de Produtos -->
  <h5>Inclusão de Produtos</h5>
  <div id="area-itens" class="mb-4">
    <table class="table table-bordered align-middle" id="tabela_itens">
      <thead style="background-color: white; color: #004aad; text-align:center;">
        <tr>
          <th style="width:5%">Item</th>
          <th style="width:10%">Qtd</th>
          <th style="width:15%">Código</th>
          <th>Descrição</th>
          <th style="width:15%">Preço Unit. (R$)</th>
          <th style="width:15%">Total (R$)</th>
          <th style="width:8%">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success mt-2" onclick="adicionarLinha()">Adicionar Produto</button>
  </div>

  <!-- Pagamento -->
  <h5>Condição de Pagamento</h5>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="1x" checked><label class="form-check-label">Boleto em 1x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="2x"><label class="form-check-label">Boleto em 2x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="3x"><label class="form-check-label">Boleto em 3x</label></div>

  <!-- Observações -->
  <div class="mt-3">
    <label>Observações</label>
    <input class="form-control" id="obs" placeholder="Observações (opcional)">
  </div>

  <div class="info-box mt-4">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para análise. Após análise financeira, será necessário envio do documento assinado e carimbado pela empresa.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" id="btnGerarPdf" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<script>
// Variáveis globais
var tabelaBody, contador=1, itens=[];

// Função para criar inputs
function criarInput(classe, tipo, placeholder){
  var input = document.createElement("input");
  input.type = tipo||"text"; input.className = "form-control " + (classe||"");
  if(placeholder) input.placeholder = placeholder;
  return input;
}

// Adicionar linha
function adicionarLinha(){
  tabelaBody = tabelaBody || document.querySelector("#tabela_itens tbody");
  var tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="text-center">${contador}</td>
    <td>${criarInputHTML("qtd","number","Qtd")}</td>
    <td>${criarInputHTML("cod","text","")}</td>
    <td>${criarInputHTML("desc","text","")}</td>
    <td>${criarInputHTML("preco","text","0,00")}</td>
    <td class="text-end total">0,00</td>
    <td class="text-center"><button type="button" class="btn btn-sm btn-danger btn-remover">X</button></td>
  `;
  tabelaBody.appendChild(tr);
  contador++;
  attachEvents(tr);
}

// Criar input como string para innerHTML
function criarInputHTML(classe,tipo,placeholder){
  return `<input type="${tipo}" class="form-control ${classe}" placeholder="${placeholder||''}">`;
}

// Adicionar eventos de input e remover
function attachEvents(tr){
  var qtdInp = tr.querySelector(".qtd");
  var precoInp = tr.querySelector(".preco");
  var btnRem = tr.querySelector(".btn-remover");
  qtdInp.addEventListener("input", calcularTotais);
  precoInp.addEventListener("input", function(){
    this.value = formatarValor(this.value);
    calcularTotais();
  });
  btnRem.addEventListener("click", function(){
    tr.remove();
    calcularTotais();
  });
}

// Formatação de valor
function formatarValor(valor){
  var s = String(valor).replace(/\D/g,"");
  if(!s) return "";
  var num = (parseFloat(s)/100).toFixed(2);
  var partes = num.split(".");
  var inteiros = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g,".");
  return inteiros + "," + partes[1];
}

// Calcular totais
function calcularTotais(){
  itens = [];
  tabelaBody = tabelaBody || document.querySelector("#tabela_itens tbody");
  var rows = tabelaBody.querySelectorAll("tr");
  rows.forEach(function(linha){
    var qtd = parseFloat(linha.querySelector(".qtd").value.replace(",",".")||0);
    var preco = parseFloat(linha.querySelector(".preco").value.replace(".","").replace(",",".")||0);
    var total = qtd*preco;
    linha.querySelector(".total").textContent = total.toLocaleString("pt-BR",{minimumFractionDigits:2});
    itens.push({
      qtd: qtd.toString(),
      cod: linha.querySelector(".cod").value,
      desc: linha.querySelector(".desc").value,
      preco: preco.toLocaleString("pt-BR",{minimumFractionDigits:2}),
      tot: total.toLocaleString("pt-BR",{minimumFractionDigits:2})
    });
  });
}

// Gerar PDF
async function gerarPDF(){
  var requiredIds = ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data","Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial","prazo"];
  for(var id of requiredIds){
    var el = document.getElementById(id);
    if(!el.value.trim()){ el.classList.add("is-invalid"); el.scrollIntoView({behavior:"smooth"}); el.focus(); return; }
  }
  calcularTotais();
  if(itens.length==0){ alert("⚠️ Adicione ao menos um item antes de gerar o PDF."); return; }

  var cliente = {}, filial = {};
  ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data"].forEach(id=>cliente[id]=document.getElementById(id).value);
  ["Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"].forEach(id=>filial[id]=document.getElementById(id).value);

  var pagamento = document.querySelector("input[name='pagamento']:checked").value;
  var payload = {cliente,filial,itens,obs:document.getElementById("obs").value,pagamento,prazo:document.getElementById("prazo").value};

  try{
    var resp = await fetch("/gerar_pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!resp.ok){ throw new Error(await resp.text()); }
    var blob = await resp.blob();
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href=url; a.download="Ordem_Compra.pdf"; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
  } catch(e){ console.error(e); alert("Erro ao gerar PDF. Veja console."); }
}

// Limpar formulário
function limpar(){
  document.querySelectorAll("input").forEach(input=>input.value="");
  document.querySelectorAll("input").forEach(input=>input.classList.remove("is-invalid"));
  if(document.getElementById("Data")) document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
  tabelaBody = document.querySelector("#tabela_itens tbody");
  tabelaBody.innerHTML=""; itens=[]; contador=1;
}

// Inicialização
document.addEventListener("DOMContentLoaded",function(){
  if(document.getElementById("Data")) document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
});
</script>
</body>
</html>
