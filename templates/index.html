<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra — Emissão (PDF)</h3>

  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-2" id="Empresa" placeholder="Empresa" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="CNPJ" placeholder="CNPJ" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Inscrição Estadual" placeholder="Inscrição Estadual" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Endereço" placeholder="Endereço" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Cidade/Estado" placeholder="Cidade/Estado" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Telefone" placeholder="Telefone" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="E-mail" placeholder="E-mail" type="email" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Data" placeholder="Data" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Nome do Responsável" placeholder="Nome do Responsável" required></div>
  </div>

  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-2" id="Nome Filial" placeholder="Nome Filial" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Ramal/Telefone" placeholder="Ramal/Telefone" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="E-mail Filial" placeholder="E-mail Filial" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Endereço Filial" placeholder="Endereço Filial" required></div>
    <div class="col-md-6"><input class="form-control mb-2" id="Cidade Filial" placeholder="Cidade Filial" required></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
  </div>

  <hr>

  <h5>Lançamento de Produtos</h5>
  <div id="area-itens">
    <div class="row mb-3">
      <div class="col"><input class="form-control" id="qtd" placeholder="Qtd" required></div>
      <div class="col"><input class="form-control" id="cod" placeholder="Código" required></div>
      <div class="col"><input class="form-control" id="desc" placeholder="Descrição" required></div>
      <div class="col"><input class="form-control" id="preco" placeholder="Preço Unitário" required></div>
      <div class="col"><button class="btn btn-success" onclick="addItem()">Adicionar</button></div>
    </div>

    <table class="table table-sm" id="tabela_itens">
      <thead><tr><th>Qtd</th><th>Código</th><th>Descrição</th><th>Preço Unit (R$)</th><th>Ações</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <h5>Condição de Pagamento</h5>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="1x" checked>
    <label class="form-check-label">Boleto em 1x</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="2x">
    <label class="form-check-label">Boleto em 2x</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="radio" name="pagamento" value="3x">
    <label class="form-check-label">Boleto em 3x</label>
  </div>

  <div class="mt-3">
    <label>Observações</label>
    <input class="form-control" id="obs" placeholder="Observações">
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
let itens = [];

$("#CNPJ").mask("00.000.000/0000-00");
$("#Telefone").mask("(00) 00000-0000");
$("#Ramal\\/Telefone").mask("(00) 00000-0000");
$("#preco").mask("0000000000,00", {reverse: true});

function addItem() {
  const q = document.getElementById("qtd").value;
  const c = document.getElementById("cod").value;
  const d = document.getElementById("desc").value;
  const p = document.getElementById("preco").value;
  if (!q || !c || !d || !p) return alert("Preencha todos os campos do item!");
  const tot = (parseFloat(q) * parseFloat(p.replace(",", "."))).toFixed(2);
  itens.push({ qtd: q, cod: c, desc: d, preco: p, tot: tot });
  atualizarTabela();
  ["qtd","cod","desc","preco"].forEach(id => document.getElementById(id).value="");
}

function atualizarTabela() {
  const tbody = document.querySelector("#tabela_itens tbody");
  tbody.innerHTML = "";
  itens.forEach((it, i) => {
    tbody.innerHTML += `<tr>
      <td>${it.qtd}</td><td>${it.cod}</td><td>${it.desc}</td><td>${it.preco}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removerItem(${i})">X</button></td></tr>`;
  });
}

function removerItem(i) {
  itens.splice(i, 1);
  atualizarTabela();
}

function limpar() {
  document.querySelectorAll("input").forEach(i => i.value = "");
  document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
  itens = [];
  atualizarTabela();
}

async function gerarPDF() {
  const obrigatoriosCliente = ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Data","Nome do Responsável"];
  const obrigatoriosFilial = ["Nome Filial","Ramal/Telefone","E-mail Filial","Endereço Filial","Cidade Filial"];

  for (let id of [...obrigatoriosCliente, ...obrigatoriosFilial]) {
    const el = document.getElementById(id);
    if (!el.value.trim()) {
      alert(`Preencha o campo obrigatório: ${id}`);
      el.focus();
      return;
    }
  }

  if (itens.length === 0) {
    alert("Adicione ao menos um item antes de gerar o PDF.");
    return;
  }

  const cliente = {};
  obrigatoriosCliente.forEach(id => cliente[id] = document.getElementById(id).value);

  const filial = {};
  obrigatoriosFilial.forEach(id => filial[id] = document.getElementById(id).value);

  const pagamento = document.querySelector("input[name='pagamento']:checked").value;
  const payload = {
    cliente, filial, itens,
    obs: document.getElementById("obs").value,
    pagamento, prazo: document.getElementById("prazo").value
  };

  const resp = await fetch("/gerar_pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const blob = await resp.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ordem_Compra.pdf";
  a.click();
}
</script>
</body>
</html>
