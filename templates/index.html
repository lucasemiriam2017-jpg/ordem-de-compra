<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input.is-invalid { border-color: #dc3545 !important; }
.invalid-feedback {
  display: none;
  color: #dc3545;
  font-size: 0.9em;
  margin-top: 2px;
}
input.is-invalid + .invalid-feedback {
  display: block;
}
.info-box {
  background: #f1f5ff;
  border-left: 4px solid #0d6efd;
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 0.95em;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra ‚Äî Emiss√£o (PDF)</h3>

  <!-- Empresa solicitante -->
  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Empresa" placeholder="Empresa" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Inscri√ß√£o Estadual" placeholder="Inscri√ß√£o Estadual" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endere√ßo" placeholder="Endere√ßo" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone" placeholder="Telefone" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail" placeholder="E-mail (para recebimento de boleto)" required><div class="invalid-feedback">‚ö†Ô∏è Digite um e-mail v√°lido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Nome do Respons√°vel" placeholder="Nome do Respons√°vel" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Data" placeholder="Data" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
  </div>

  <!-- Filial / Fornecedor -->
  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endere√ßo Filial" placeholder="Endere√ßo Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" required><div class="invalid-feedback">‚ö†Ô∏è Digite um e-mail v√°lido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Ramal" placeholder="Ramal" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div>
  </div>

  <hr>

  <!-- Inclus√£o de Produtos (Nova vers√£o din√¢mica) -->
  <h5>Inclus√£o de Produtos</h5>
  <div id="area-itens" class="mb-4">
    <table class="table table-bordered align-middle" id="tabela_itens">
      <thead style="background-color: white; color: #004aad; text-align:center;">
        <tr>
          <th style="width:5%">Item</th>
          <th style="width:10%">Qtd</th>
          <th style="width:15%">C√≥digo</th>
          <th>Descri√ß√£o</th>
          <th style="width:15%">Pre√ßo Unit. (R$)</th>
          <th style="width:15%">Total (R$)</th>
          <th style="width:8%">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success mt-2" onclick="adicionarLinha()">Adicionar Produto</button>
  </div>

  <!-- Pagamento -->
  <h5>Condi√ß√£o de Pagamento</h5>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="1x" checked><label class="form-check-label">Boleto em 1x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="2x"><label class="form-check-label">Boleto em 2x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="3x"><label class="form-check-label">Boleto em 3x</label></div>

  <!-- Observa√ß√µes -->
  <div class="mt-3">
    <label>Observa√ß√µes</label>
    <input class="form-control" id="obs" placeholder="Observa√ß√µes (opcional)">
  </div>

  <div class="info-box mt-4">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para an√°lise. Ap√≥s a an√°lise financeira (poder√° ser solicitado um valor de ENTRADA), ser√° necess√°rio o requerimento assinado e carimbado pela empresa (cliente). Ap√≥s o envio por e-mail do documento assinado e carimbado, ser√° liberado o limite e seguiremos com as instru√ß√µes para realiza√ß√£o da venda.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<script>
// === M√°scaras e inicializa√ß√£o ===
document.addEventListener("DOMContentLoaded", function() {
  const cnpj = document.getElementById("CNPJ");
  const telefone = document.getElementById("Telefone");
  const telefoneFilial = document.getElementById("Telefone Filial");
  const data = document.getElementById("Data");

  const maskCNPJ = v => v.replace(/\D/g,"").replace(/^(\d{2})(\d)/,"$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3").replace(/\.(\d{3})(\d)/,".$1/$2").replace(/(\d{4})(\d)/,"$1-$2").slice(0,18);
  const maskTel = v => v.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d{5})(\d{4})$/,"$1-$2").slice(0,15);

  cnpj.addEventListener("input", e => e.target.value = maskCNPJ(e.target.value));
  telefone.addEventListener("input", e => e.target.value = maskTel(e.target.value));
  telefoneFilial.addEventListener("input", e => e.target.value = maskTel(e.target.value));
  data.value = new Date().toLocaleDateString("pt-BR");
});

// === Controle de Itens ===
let contador = 1;
let itens = [];

function formatarValor(valor) {
  valor = valor.replace(/\D/g,"");
  if (!valor) return "";
  valor = (parseFloat(valor)/100).toFixed(2);
  return valor.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

function adicionarLinha() {
  const tabela = document.querySelector("#tabela_itens tbody");
  const linha = document.createElement("tr");
  linha.innerHTML = `
    <td class="text-center">${contador}</td>
    <td><input type="number" class="form-control qtd" min="1" placeholder="Qtd"></td>
    <td><input type="text" class="form-control cod"></td>
    <td><input type="text" class="form-control desc"></td>
    <td><input type="text" class="form-control preco" placeholder="0,00"></td>
    <td class="text-end total">0,00</td>
    <td class="text-center"><button class="btn btn-sm btn-danger" onclick="removerLinha(this)">X</button></td>
  `;
  tabela.appendChild(linha);
  contador++;
  atualizarEventos();
}

function atualizarEventos() {
  document.querySelectorAll(".preco, .qtd").forEach(inp => {
    inp.addEventListener("input", calcularTotais);
  });
  document.querySelectorAll(".preco").forEach(inp => {
    inp.addEventListener("input", e => {
      e.target.value = formatarValor(e.target.value);
      calcularTotais(); // üî• recalcula total ao alterar o pre√ßo
    });
  });
}

function calcularTotais() {
  const linhas = document.querySelectorAll("#tabela_itens tbody tr");
  itens = [];
  linhas.forEach((linha) => {
    const qtd = parseFloat(linha.querySelector(".qtd").value) || 0;
    const cod = linha.querySelector(".cod").value;
    const desc = linha.querySelector(".desc").value;
    const precoStr = linha.querySelector(".preco").value;
    const preco = parseFloat(precoStr.replace(/\./g,"").replace(",",".")) || 0;
    const total = qtd * preco;
    linha.querySelector(".total").textContent = total.toLocaleString("pt-BR",{minimumFractionDigits:2});
    itens.push({qtd:qtd.toString(), cod, desc, preco: preco.toLocaleString("pt-BR",{minimumFractionDigits:2}), tot: total.toLocaleString("pt-BR",{minimumFractionDigits:2})});
  });
}

function removerLinha(btn) {
  btn.closest("tr").remove();
  calcularTotais();
}

// === Valida√ß√£o e gera√ß√£o PDF ===
document.querySelectorAll("input[required]").forEach(input=>{
  input.addEventListener("blur",()=>{ if(!input.value.trim()) input.classList.add("is-invalid"); });
  input.addEventListener("input",()=>{ if(input.value.trim()) input.classList.remove("is-invalid"); });
});

async function gerarPDF() {
  const obrigatorios = ["Empresa","CNPJ","Inscri√ß√£o Estadual","Endere√ßo","Cidade/Estado","Telefone","E-mail","Nome do Respons√°vel","Data","Nome Filial","Endere√ßo Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial","prazo"];
  let primeiroErro = null;
  for(const id of obrigatorios){
    const el = document.getElementById(id);
    if(!el.value.trim()){ el.classList.add("is-invalid"); if(!primeiroErro) primeiroErro=el; }
  }
  if(primeiroErro){ primeiroErro.scrollIntoView({behavior:"smooth",block:"center"}); primeiroErro.focus(); return; }
  if(itens.length===0){ alert("‚ö†Ô∏è Adicione ao menos um item antes de gerar o PDF."); return; }

  const cliente={}, filial={};
  ["Empresa","CNPJ","Inscri√ß√£o Estadual","Endere√ßo","Cidade/Estado","Telefone","E-mail","Nome do Respons√°vel","Data"].forEach(id=>cliente[id]=document.getElementById(id).value);
  ["Nome Filial","Endere√ßo Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"].forEach(id=>filial[id]=document.getElementById(id).value);

  const pagamento=document.querySelector("input[name='pagamento']:checked").value;
  const payload={cliente, filial, itens, obs:document.getElementById("obs").value, pagamento, prazo:document.getElementById("prazo").value};

  const resp=await fetch("/gerar_pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const blob=await resp.blob();
  const url=window.URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="Ordem_Compra.pdf"; a.click();
}

function limpar() {
  document.querySelectorAll("input").forEach(i=>{i.value="";i.classList.remove("is-invalid");});
  document.getElementById("Data").value=new Date().toLocaleDateString("pt-BR");
  document.querySelector("#tabela_itens tbody").innerHTML="";
  itens=[];
}
</script>
</body>
</html>
