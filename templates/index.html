<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input.is-invalid { border-color: #dc3545 !important; }
.invalid-feedback {
  display: none;
  color: #dc3545;
  font-size: 0.9em;
  margin-top: 2px;
}
input.is-invalid + .invalid-feedback {
  display: block;
}
.info-box {
  background: #f1f5ff;
  border-left: 4px solid #0d6efd;
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 0.95em;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra ‚Äî Emiss√£o (PDF)</h3>

  <!-- Empresa solicitante -->
  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Empresa" placeholder="Empresa" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Inscri√ß√£o Estadual" placeholder="Inscri√ß√£o Estadual" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endere√ßo" placeholder="Endere√ßo" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone" placeholder="Telefone" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail" placeholder="E-mail (para recebimento de boleto)" required><div class="invalid-feedback">‚ö†Ô∏è Digite um e-mail v√°lido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Nome do Respons√°vel" placeholder="Nome do Respons√°vel" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Data" placeholder="Data" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
  </div>

  <!-- Filial / Fornecedor -->
  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endere√ßo Filial" placeholder="Endere√ßo Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" required><div class="invalid-feedback">‚ö†Ô∏è Digite um e-mail v√°lido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Ramal" placeholder="Ramal" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required><div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="invalid-feedback">‚ö†Ô∏è Preencha este campo.</div>
  </div>

  <hr>

  <!-- Inclus√£o de Produtos (Nova vers√£o din√¢mica) -->
  <h5>Inclus√£o de Produtos</h5>
  <div id="area-itens" class="mb-4">
    <table class="table table-bordered align-middle" id="tabela_itens">
      <thead style="background-color: white; color: #004aad; text-align:center;">
        <tr>
          <th style="width:5%">Item</th>
          <th style="width:10%">Qtd</th>
          <th style="width:15%">C√≥digo</th>
          <th>Descri√ß√£o</th>
          <th style="width:15%">Pre√ßo Unit. (R$)</th>
          <th style="width:15%">Total (R$)</th>
          <th style="width:8%">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success mt-2" onclick="adicionarLinha()">Adicionar Produto</button>
  </div>

  <!-- Pagamento -->
  <h5>Condi√ß√£o de Pagamento</h5>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="1x" checked><label class="form-check-label">Boleto em 1x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="2x"><label class="form-check-label">Boleto em 2x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="3x"><label class="form-check-label">Boleto em 3x</label></div>

  <!-- Observa√ß√µes -->
  <div class="mt-3">
    <label>Observa√ß√µes</label>
    <input class="form-control" id="obs" placeholder="Observa√ß√µes (opcional)">
  </div>

  <div class="info-box mt-4">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para an√°lise. Ap√≥s a an√°lise financeira (poder√° ser solicitado um valor de ENTRADA), ser√° necess√°rio o requerimento assinado e carimbado pela empresa (cliente). Ap√≥s o envio por e-mail do documento assinado e carimbado, ser√° liberado o limite e seguiremos com as instru√ß√µes para realiza√ß√£o da venda.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" id="btnGerarPdf" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<!-- Script principal (corrigido, compat√≠vel com Firefox/Chrome) -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // m√°scaras e init
  var cnpj = document.getElementById("CNPJ");
  var telefone = document.getElementById("Telefone");
  var telefoneFilial = document.getElementById("Telefone Filial");
  var data = document.getElementById("Data");

  function maskCNPJ(v){ return v.replace(/\D/g,"").replace(/^(\d{2})(\d)/,"$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3").replace(/\.(\d{3})(\d)/,".$1/$2").replace(/(\d{4})(\d)/,"$1-$2").slice(0,18); }
  function maskTel(v){ return v.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d{5})(\d{4})$/,"$1-$2").slice(0,15); }

  if(cnpj) cnpj.addEventListener("input", function(e){ e.target.value = maskCNPJ(e.target.value); });
  if(telefone) telefone.addEventListener("input", function(e){ e.target.value = maskTel(e.target.value); });
  if(telefoneFilial) telefoneFilial.addEventListener("input", function(e){ e.target.value = maskTel(e.target.value); });
  if(data) data.value = new Date().toLocaleDateString("pt-BR");

  // tabela
  var tabelaBody = document.querySelector("#tabela_itens tbody");
  if(!tabelaBody){ console.error("Tabela de itens n√£o encontrada"); return; }
  var contador = 1;
  var itens = [];

  function formatarValor(valor){
    var s = String(valor).replace(/\D/g,"");
    if(!s) return "";
    var num = (parseFloat(s)/100).toFixed(2);
    var partes = num.split(".");
    var inteiros = partes[0], decimais = partes[1];
    inteiros = inteiros.replace(/\B(?=(\d{3})+(?!\d))/g,".");
    return inteiros + "," + decimais;
  }

  function criarInput(classe, tipo, placeholder){
    var input = document.createElement("input");
    input.type = tipo || "text";
    input.className = "form-control " + (classe || "");
    if(placeholder) input.placeholder = placeholder;
    return input;
  }

  window.adicionarLinha = function(){
    var tr = document.createElement("tr");
    var tdItem = document.createElement("td"); tdItem.className="text-center"; tdItem.textContent=contador;
    var tdQtd = document.createElement("td"); var inpQtd = criarInput("qtd","number","Qtd"); inpQtd.min="0"; tdQtd.appendChild(inpQtd);
    var tdCod = document.createElement("td"); tdCod.appendChild(criarInput("cod","text",""));
    var tdDesc = document.createElement("td"); tdDesc.appendChild(criarInput("desc","text",""));
    var tdPreco = document.createElement("td"); var inpPreco = criarInput("preco","text","0,00"); tdPreco.appendChild(inpPreco);
    var tdTotal = document.createElement("td"); tdTotal.className="text-end total"; tdTotal.textContent="0,00";
    var tdAcoes = document.createElement("td"); tdAcoes.className="text-center";
    var btnRem = document.createElement("button"); btnRem.type="button"; btnRem.className="btn btn-sm btn-danger btn-remover"; btnRem.textContent="X";
    tdAcoes.appendChild(btnRem);

    tr.appendChild(tdItem); tr.appendChild(tdQtd); tr.appendChild(tdCod); tr.appendChild(tdDesc);
    tr.appendChild(tdPreco); tr.appendChild(tdTotal); tr.appendChild(tdAcoes);
    tabelaBody.appendChild(tr);
    contador++;
  };

  function calcularTotais(){
    itens = [];
    var rows = tabelaBody.querySelectorAll("tr");
    for(var i=0;i<rows.length;i++){
      var linha = rows[i];
      var qtdInp = linha.querySelector(".qtd");
      var codInp = linha.querySelector(".cod");
      var descInp = linha.querySelector(".desc");
      var precoInp = linha.querySelector(".preco");
      var totalCell = linha.querySelector(".total");

      var qtd = 0;
      if(qtdInp && qtdInp.value !== ""){ qtd = parseFloat(String(qtdInp.value).replace(",", ".")); if(isNaN(qtd)) qtd = 0; }

      var preco = 0;
      if(precoInp && precoInp.value !== ""){
        var p = String(precoInp.value).replace(/\./g,"").replace(",", ".");
        preco = parseFloat(p);
        if(isNaN(preco)) preco = 0;
      }

      var total = qtd * preco;
      var totalFmt = total.toLocaleString("pt-BR",{minimumFractionDigits:2});
      if(totalCell) totalCell.textContent = totalFmt;

      itens.push({
        qtd: qtd.toString(),
        cod: codInp ? codInp.value : "",
        desc: descInp ? descInp.value : "",
        preco: (preco).toLocaleString("pt-BR",{minimumFractionDigits:2}),
        tot: totalFmt
      });
    }
  }

  // delegation para inputs na tabela
  tabelaBody.addEventListener("input", function(evt){
    var t = evt.target || evt.srcElement;
    if(!t) return;
    if(t.classList && t.classList.contains("preco")){
      t.value = formatarValor(t.value);
      calcularTotais();
      return;
    }
    if(t.classList && t.classList.contains("qtd")){
      calcularTotais();
      return;
    }
  });

  // delegation para remover linha
  tabelaBody.addEventListener("click", function(evt){
    var t = evt.target || evt.srcElement;
    if(!t) return;
    if(t.classList && t.classList.contains("btn-remover")){
      var tr = t.closest("tr");
      if(tr && tr.parentNode){ tr.parentNode.removeChild(tr); calcularTotais(); }
    }
  });

  // valida√ß√£o suave
  var requiredInputs = document.querySelectorAll("input[required]");
  for(var k=0;k<requiredInputs.length;k++){
    (function(input){
      input.addEventListener("blur", function(){ if(!String(input.value||"").trim()) input.classList.add("is-invalid"); });
      input.addEventListener("input", function(){ if(String(input.value||"").trim()) input.classList.remove("is-invalid"); });
    })(requiredInputs[k]);
  }

  // gerar PDF
  window.gerarPDF = async function(){
    var obrigatorios = ["Empresa","CNPJ","Inscri√ß√£o Estadual","Endere√ßo","Cidade/Estado","Telefone","E-mail","Nome do Respons√°vel","Data","Nome Filial","Endere√ßo Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial","prazo"];
    var primeiroErro = null;
    for(var i=0;i<obrigatorios.length;i++){
      var id = obrigatorios[i];
      var el = document.getElementById(id);
      if(el && !String(el.value||"").trim()){ el.classList.add("is-invalid"); if(!primeiroErro) primeiroErro = el; }
    }
    if(primeiroErro){ primeiroErro.scrollIntoView({behavior:"smooth", block:"center"}); primeiroErro.focus(); return; }

    calcularTotais();
    if(itens.length === 0){ alert("‚ö†Ô∏è Adicione ao menos um item antes de gerar o PDF."); return; }

    var cliente = {};
    var camposCliente = ["Empresa","CNPJ","Inscri√ß√£o Estadual","Endere√ßo","Cidade/Estado","Telefone","E-mail","Nome do Respons√°vel","Data"];
    for(var ci=0; ci<camposCliente.length; ci++){ var idc = camposCliente[ci]; var elc = document.getElementById(idc); cliente[idc] = elc ? elc.value : ""; }

    var filial = {};
    var camposFilial = ["Nome Filial","Endere√ßo Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"];
    for(var cf=0; cf<camposFilial.length; cf++){ var idf = camposFilial[cf]; var elf = document.getElementById(idf); filial[idf] = elf ? elf.value : ""; }

    var pagamento = (document.querySelector("input[name='pagamento']:checked") || {}).value || "";
    var payload = { cliente: cliente, filial: filial, itens: itens, obs: (document.getElementById("obs")?document.getElementById("obs").value:""), pagamento: pagamento, prazo: (document.getElementById("prazo")?document.getElementById("prazo").value:"") };

    try{
      var resp = await fetch("/gerar_pdf", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      if(!resp.ok){ var text = await resp.text(); throw new Error("Servidor retornou erro: " + (text || resp.statusText || resp.status)); }
      var blob = await resp.blob();
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "Ordem_Compra.pdf";
      document.body.appendChild(a); // necess√°rio para Firefox
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch(err){
      console.error("Erro gerarPDF:", err);
      alert("Erro ao gerar PDF. Veja console para detalhes.");
    }
  };

  // limpar
  window.limpar = function(){
    var allInputs = document.querySelectorAll("input");
    for(var ii=0; ii<allInputs.length; ii++){ allInputs[ii].value = ""; allInputs[ii].classList.remove("is-invalid"); }
    if(document.getElementById("Data")) document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
    tabelaBody.innerHTML = "";
    itens = [];
    contador = 1;
  };

}); // end DOMContentLoaded
</script>

<!-- Detector: se for Firefox carrega ajustes extras -->
<script>
  (function(){
    var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
    if(isFirefox){
      var script = document.createElement('script');
      script.src = '/static/firefox.js';
      document.body.appendChild(script);
      console.log("üî• firefox.js solicitado");
    }
  })();
</script>
</body>
</html>
