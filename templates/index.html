<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ordem de Compra (Web)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background-color: #f8f9fa; padding: 20px; }
.container { max-width: 950px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
h5 { margin-top: 30px; }
.logo { display: block; margin: 0 auto 15px; max-width: 200px; }
#area-itens { margin-top: 25px; }
input.is-invalid { border-color: #dc3545 !important; }
.invalid-feedback {
  display: none;
  color: #dc3545;
  font-size: 0.9em;
  margin-top: 2px;
}
input.is-invalid + .invalid-feedback {
  display: block;
}
.info-box {
  background: #f1f5ff;
  border-left: 4px solid #0d6efd;
  padding: 10px 15px;
  border-radius: 6px;
  font-size: 0.95em;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div class="container">
  <img src="/static/logo.png" alt="Logo" class="logo">
  <h3 class="text-center mb-4">Ordem de Compra — Emissão (PDF)</h3>

  <!-- Empresa solicitante -->
  <h5>Empresa Solicitante</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Empresa" placeholder="Empresa" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="CNPJ" placeholder="CNPJ" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Inscrição Estadual" placeholder="Inscrição Estadual" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço" placeholder="Endereço" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado" placeholder="Cidade/Estado" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone" placeholder="Telefone" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail" placeholder="E-mail (para recebimento de boleto)" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Nome do Responsável" placeholder="Nome do Responsável" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Data" placeholder="Data" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <!-- Filial / Fornecedor -->
  <h5>Filial / Fornecedor</h5>
  <div class="row">
    <div class="col-md-6"><input class="form-control mb-1" id="Nome Filial" placeholder="Nome Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Endereço Filial" placeholder="Endereço Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Telefone Filial" placeholder="Telefone Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input type="email" class="form-control mb-1" id="E-mail Filial" placeholder="E-mail Filial" required><div class="invalid-feedback">⚠️ Digite um e-mail válido.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Ramal" placeholder="Ramal" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
    <div class="col-md-6"><input class="form-control mb-1" id="Cidade/Estado Filial" placeholder="Cidade/Estado Filial" required><div class="invalid-feedback">⚠️ Preencha este campo.</div></div>
  </div>

  <div class="mb-3">
    <label>Prazo de Entrega</label>
    <input class="form-control" id="prazo" placeholder="Prazo de entrega" value="IMEDIATO" required>
    <div class="invalid-feedback">⚠️ Preencha este campo.</div>
  </div>

  <hr>

  <!-- Inclusão de Produtos -->
  <h5>Inclusão de Produtos</h5>
  <div id="area-itens" class="mb-4">
    <table class="table table-bordered align-middle" id="tabela_itens">
      <thead style="background-color: white; color: #004aad; text-align:center;">
        <tr>
          <th style="width:5%">Item</th>
          <th style="width:10%">Qtd</th>
          <th style="width:15%">Código</th>
          <th>Descrição</th>
          <th style="width:15%">Preço Unit. (R$)</th>
          <th style="width:15%">Total (R$)</th>
          <th style="width:8%">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-success mt-2" onclick="adicionarLinha()">Adicionar Produto</button>
  </div>

  <!-- Pagamento -->
  <h5>Condição de Pagamento</h5>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="1x" checked><label class="form-check-label">Boleto em 1x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="2x"><label class="form-check-label">Boleto em 2x</label></div>
  <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="pagamento" value="3x"><label class="form-check-label">Boleto em 3x</label></div>

  <!-- Observações -->
  <div class="mt-3">
    <label>Observações</label>
    <input class="form-control" id="obs" placeholder="Observações (opcional)">
  </div>

  <div class="info-box mt-4">
    <b>Processo da ordem de compra:</b><br>
    Enviar a ordem de compra emitida para análise. Após a análise financeira (poderá ser solicitado um valor de ENTRADA), será necessário o requerimento assinado e carimbado pela empresa (cliente). Após o envio por e-mail do documento assinado e carimbado, será liberado o limite e seguiremos com as instruções para realização da venda.
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-primary" onclick="gerarPDF()">Gerar PDF</button>
    <button class="btn btn-secondary" onclick="limpar()">Limpar</button>
  </div>
</div>

<script>
/* Compatível Firefox / Chrome / Edge
   Substitua todo o bloco <script> do seu arquivo por este. */
document.addEventListener("DOMContentLoaded", function () {
  // máscaras iniciais (mantive sua lógica original)
  var cnpj = document.getElementById("CNPJ");
  var telefone = document.getElementById("Telefone");
  var telefoneFilial = document.getElementById("Telefone Filial");
  var data = document.getElementById("Data");

  function maskCNPJ(v) {
    return v.replace(/\D/g,"")
            .replace(/^(\d{2})(\d)/,"$1.$2")
            .replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")
            .replace(/\.(\d{3})(\d)/,".$1/$2")
            .replace(/(\d{4})(\d)/,"$1-$2")
            .slice(0,18);
  }
  function maskTel(v) {
    return v.replace(/\D/g,"")
            .replace(/^(\d{2})(\d)/g,"($1) $2")
            .replace(/(\d{5})(\d{4})$/,"$1-$2")
            .slice(0,15);
  }

  if (cnpj) cnpj.addEventListener("input", function(e){ e.target.value = maskCNPJ(e.target.value); });
  if (telefone) telefone.addEventListener("input", function(e){ e.target.value = maskTel(e.target.value); });
  if (telefoneFilial) telefoneFilial.addEventListener("input", function(e){ e.target.value = maskTel(e.target.value); });
  if (data) data.value = new Date().toLocaleDateString("pt-BR");

  // tabela e controle de linhas
  var tabelaBody = document.querySelector("#tabela_itens tbody");
  var contador = 1;
  var itens = [];

  function formatarValor(valor) {
    valor = String(valor).replace(/\D/g,"");
    if (!valor) return "";
    var num = (parseFloat(valor)/100).toFixed(2);
    return num.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
  }

  // adiciona linha — sem handlers inline
  function adicionarLinha() {
    var linha = document.createElement("tr");
    linha.innerHTML = ''
      + '<td class="text-center">' + contador + '</td>'
      + '<td><input type="number" class="form-control qtd" min="0" placeholder="Qtd" value=""></td>'
      + '<td><input type="text" class="form-control cod" value=""></td>'
      + '<td><input type="text" class="form-control desc" value=""></td>'
      + '<td><input type="text" class="form-control preco" placeholder="0,00" value=""></td>'
      + '<td class="text-end total">0,00</td>'
      + '<td class="text-center"><button type="button" class="btn btn-sm btn-danger btn-remover">X</button></td>';
    tabelaBody.appendChild(linha);
    contador++;
    // não adicionamos listeners por linha: usamos delegation abaixo
  }

  // delegation: captura inputs na tabela (funciona no Firefox)
  tabelaBody.addEventListener("input", function (evt) {
    var target = evt.target || evt.srcElement;
    if (!target) return;

    // se é campo preco -> formata e recalcula
    if (target.classList && target.classList.contains("preco")) {
      var cur = target.value;
      var selStart = target.selectionStart;
      target.value = formatarValor(cur);
      // recalc totals
      calcularTotais();
      return;
    }

    // se é qtd -> recalcula
    if (target.classList && target.classList.contains("qtd")) {
      calcularTotais();
      return;
    }
  });

  // delegation: captura clicks (remover)
  tabelaBody.addEventListener("click", function (evt) {
    var target = evt.target || evt.srcElement;
    if (!target) return;
    if (target.classList && target.classList.contains("btn-remover")) {
      var tr = target.closest("tr");
      if (tr) {
        tr.parentNode.removeChild(tr);
        calcularTotais();
      }
    }
  });

  // recalcula totais lendo todas as linhas
  function calcularTotais() {
    var linhas = tabelaBody.querySelectorAll("tr");
    itens = [];
    for (var i = 0; i < linhas.length; i++) {
      var linha = linhas[i];
      var qtdInp = linha.querySelector(".qtd");
      var codInp = linha.querySelector(".cod");
      var descInp = linha.querySelector(".desc");
      var precoInp = linha.querySelector(".preco");
      var totalCell = linha.querySelector(".total");

      var qtd = 0;
      if (qtdInp && qtdInp.value !== "") {
        qtd = parseFloat(String(qtdInp.value).replace(",", "."));
        if (isNaN(qtd)) qtd = 0;
      }

      var preco = 0;
      if (precoInp && precoInp.value !== "") {
        var precoNum = String(precoInp.value).replace(/\./g, "").replace(",", ".");
        preco = parseFloat(precoNum);
        if (isNaN(preco)) preco = 0;
      }

      var total = qtd * preco;
      // formata para pt-BR com 2 decimais
      var totalFmt = (total).toLocaleString("pt-BR", { minimumFractionDigits: 2 });
      if (totalCell) totalCell.textContent = totalFmt;

      itens.push({
        qtd: qtd.toString(),
        cod: (codInp ? codInp.value : "") || "",
        desc: (descInp ? descInp.value : "") || "",
        preco: (preco).toLocaleString("pt-BR", { minimumFractionDigits: 2 }),
        tot: totalFmt
      });
    }
  }

  // expor funções globais usadas no HTML (botões que chamam adicionarLinha(), gerarPDF(), limpar())
  window.adicionarLinha = adicionarLinha;

  // gerarPDF (compatível Firefox)
  window.gerarPDF = async function () {
    // valida campos obrigatórios (mesma lista que você usa)
    var obrigatorios = ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data","Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial","prazo"];
    var primeiroErro = null;
    for (var i = 0; i < obrigatorios.length; i++) {
      var id = obrigatorios[i];
      var el = document.getElementById(id);
      if (el) {
        if (!String(el.value || "").trim()) {
          el.classList.add("is-invalid");
          if (!primeiroErro) primeiroErro = el;
        }
      }
    }
    if (primeiroErro) {
      primeiroErro.scrollIntoView({ behavior: "smooth", block: "center" });
      primeiroErro.focus();
      return;
    }

    // recalcula uma última vez e checa itens
    calcularTotais();
    if (itens.length === 0) {
      alert("⚠️ Adicione ao menos um item antes de gerar o PDF.");
      return;
    }

    // montar payload
    var cliente = {};
    var filial = {};
    var camposCliente = ["Empresa","CNPJ","Inscrição Estadual","Endereço","Cidade/Estado","Telefone","E-mail","Nome do Responsável","Data"];
    for (var i = 0; i < camposCliente.length; i++) {
      var id = camposCliente[i];
      var el = document.getElementById(id);
      cliente[id] = el ? el.value : "";
    }
    var camposFilial = ["Nome Filial","Endereço Filial","Telefone Filial","E-mail Filial","Ramal","Cidade/Estado Filial"];
    for (var j = 0; j < camposFilial.length; j++) {
      var idf = camposFilial[j];
      var el2 = document.getElementById(idf);
      filial[idf] = el2 ? el2.value : "";
    }

    var pagamento = (document.querySelector("input[name='pagamento']:checked") || {}).value || "";
    var payload = {
      cliente: cliente,
      filial: filial,
      itens: itens,
      obs: (document.getElementById("obs") ? document.getElementById("obs").value : ""),
      pagamento: pagamento,
      prazo: (document.getElementById("prazo") ? document.getElementById("prazo").value : "")
    };

    try {
      var resp = await fetch("/gerar_pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        var text = await resp.text();
        throw new Error("Erro servidor: " + text);
      }

      var blob = await resp.blob();
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "Ordem_Compra.pdf";
      // necessário para Firefox: elemento deve estar no DOM antes do click
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("Erro ao gerar PDF:", err);
      alert("Erro ao gerar PDF. Veja o console do navegador para mais detalhes.");
    }
  };

  // limpar (exposto globalmente também)
  window.limpar = function () {
    var inputs = document.querySelectorAll("input");
    for (var k = 0; k < inputs.length; k++) {
      inputs[k].value = "";
      inputs[k].classList.remove("is-invalid");
    }
    if (document.getElementById("Data")) {
      document.getElementById("Data").value = new Date().toLocaleDateString("pt-BR");
    }
    tabelaBody.innerHTML = "";
    itens = [];
    contador = 1;
  };

  // função removerLinha usada somente por delegation (botão .btn-remover)
  // (não precisa definir globalmente)

  // fim do DOMContentLoaded
});
</script>
</body>
</html>
